#define BSD
//#define TINY_ECC

#include <assert.h>
#include <stdio.h>
#include "curve.h"

#if defined(TINY_ECC)
#include "tiny_ecc/ecdh.h"
#elif defined(BSD)
#include "bsd/uECC.h"
#endif

#if defined(TINY_ECC)
#define ECC_PUB_SIZE ECC_PUB_KEY_SIZE
 #define ECC_PRV_SIZE ECC_PRV_KEY_SIZE
#elif defined(BSD)
#define ECC_PUB_SIZE 64
#define ECC_PRV_SIZE 32
#endif

uint8_t pub_a[ECC_PUB_SIZE];
uint8_t prv_a[ECC_PRV_SIZE];
uint8_t sec_a[ECC_PUB_SIZE];
uint8_t pub_b[ECC_PUB_SIZE];
uint8_t prv_b[ECC_PRV_SIZE];
uint8_t sec_b[ECC_PUB_SIZE];
uint32_t i;
const struct uECC_Curve_t * curves;

void init_ecc() {
#if defined(TINY_ECC)

    static int initialized = 0;
    if (!initialized)
    {
        prng_init((0xbad ^ 0xc0ffee ^ 42) | 0xcafebabe | 666);
        initialized = 1;
    }

    for (i = 0; i < ECC_PRV_SIZE; ++i)
    {
        prv_a[i] = prng_next();
    }
    ecdh_generate_keys(pub_a, prv_a);

#elif defined(BSD)
#if uECC_SUPPORTS_secp160r1
    uint8_t temp_prv_a[ECC_PRV_SIZE] = {0x00 ,0x33 ,0x05 ,0xFA ,0xD2 ,0x12 ,0xCE ,0x9D ,0xC4 ,0xF1 ,0x6A ,0x43 ,0xE3 ,0xBD ,0x20 ,0x2E ,0x94 ,0x99 ,0xBE ,0x4D ,0xC2 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00};
    uint8_t temp_prv_b[ECC_PRV_SIZE = {0x00 ,0x51 ,0xD3 ,0x0D ,0x39 ,0x0B ,0xB3 ,0xB8 ,0xF5 ,0x9E ,0xA4 ,0xCA ,0x63 ,0x1B ,0x19 ,0x72 ,0x0E ,0x75 ,0x98 ,0x29 ,0x0A ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00};
    uint8_t temp_pub_a[ECC_PUB_SIZE] = {0x88 ,0x56 ,0x69 ,0x37 ,0x2F ,0xF3 ,0x68 ,0x3A ,0x8B ,0x14 ,0x38 ,0x8B ,0xA6 ,0xD0 ,0x14 ,0x09 ,0x3E ,0xC1 ,0xBC ,0x19 ,0xC9 ,0xED ,0x39 ,0x89 ,0x4E ,0xA7 ,0x41 ,0x81 ,0xE1 ,0x87 ,0x63 ,0x44 ,0xE4 ,0x74 ,0x6F ,0x0D ,0x7D ,0xFF ,0xE4 ,0xEC ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00};
    uint8_t temp_pub_b[ECC_PUB_SIZE = {0x0B ,0x50 ,0x18 ,0xCB ,0x09 ,0x9C ,0x5C ,0xA1 ,0xBC ,0xFF ,0x92 ,0x08 ,0xC7 ,0x56 ,0x41 ,0xC1 ,0xEA ,0x52 ,0xCB ,0x07 ,0xA0 ,0xF6 ,0xDE ,0x93 ,0x66 ,0xD9 ,0x8A ,0x26 ,0x71 ,0xBC ,0xFC ,0xD1 ,0xE8 ,0x00 ,0x6A ,0xB1 ,0xED ,0x9C ,0x54 ,0xAA ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00};
#elif uECC_SUPPORTS_secp192r1
    uint8_t temp_prv_a[ECC_PRV_SIZE] = {0xb1, 0x9a, 0x93, 0x78, 0xff, 0x7e,  0x72, 0x41, 0x9c, 0x37, 0xbc, 0x32, 0x5e, 0xb4, 0x3c, 0x9b, 0xa, 0x8d, 0x9f, 0x9b, 0x5e, 0x27, 0x80, 0x97, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0};
    uint8_t temp_prv_b[ECC_PRV_SIZE = {0xf0, 0x38, 0xdd, 0x9b, 0x2c, 0xae,  0xce, 0x44, 0xe2, 0xa6, 0xda, 0x9d, 0x3b, 0x1e,  0x86, 0xef, 0xa2, 0x44, 0xe1, 0x6b, 0x6e, 0x9a, 0xd5, 0x10, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0};
    uint8_t temp_pub_a[ECC_PUB_SIZE] = {0xbf, 0x65, 0xd4, 0xee, 0xc7, 0x6a,  0x54, 0xa3, 0xc4, 0xa7, 0x71, 0xf8, 0x0, 0x10,  0x3a, 0xfc, 0x67, 0x84, 0x22, 0x87, 0x2b, 0x43,  0xbb, 0xe4, 0x42, 0x20, 0x16, 0x35, 0xc8, 0x2b,  0x4f, 0x21, 0x25, 0x3e, 0x2b, 0xd6, 0x8c, 0x9e,  0xe3, 0x22, 0xb1, 0x76, 0x31, 0x92, 0x92, 0xa7,  0x7f, 0x34, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,  0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,  0x0, 0x0};
    uint8_t temp_pub_b[ECC_PUB_SIZE = {0x88, 0xcf, 0xef, 0x8c, 0x1f, 0x77,  0x7f, 0x44, 0xe, 0x3b, 0x71, 0xf, 0xd2, 0x21,  0x6a, 0x88, 0x66, 0x1c, 0x17, 0x1d, 0x5f, 0x4e,  0x5b, 0x6, 0x5, 0x30, 0xed, 0x86, 0x6, 0x93,  0x87, 0x2f, 0x4a, 0x9c, 0xba, 0x5c, 0xa8, 0x87,  0x20, 0x25, 0x74, 0x4, 0x12, 0xa8, 0xaa, 0xa6,  0xb1, 0xce, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,  0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,  0x0, 0x0};
#elif uECC_SUPPORTS_secp224r1
    uint8_t temp_prv_a[ECC_PRV_SIZE] = {0xA5 ,0x93 ,0xDC ,0xA7 ,0x8C ,0xAA ,0x6A ,0xFF ,0xEE ,0xCE ,0xA2 ,0x35 ,0x61 ,0xB6 ,0x2B ,0xEB ,0x66 ,0x3C ,0x36 ,0xCB ,0x43 ,0x87 ,0x7A ,0x74 ,0xEC ,0x9F ,0xAC ,0x77 ,0x00 ,0x00 ,0x00 ,0x00};
    uint8_t temp_prv_b[ECC_PRV_SIZE = {0xA6 ,0x83 ,0xC3 ,0x6D ,0xAE ,0x08 ,0x9B ,0x27 ,0x8F ,0xF6 ,0xF7 ,0x36 ,0x6D ,0x57 ,0x1C ,0x56 ,0xFF ,0x07 ,0x4F ,0xF9 ,0xAF ,0x91 ,0x23 ,0x7E ,0x2F ,0x9A ,0xFC ,0xC4 ,0x00 ,0x00 ,0x00 ,0x00};
    uint8_t temp_pub_a[ECC_PUB_SIZE] = {0x66 ,0xA8 ,0x54 ,0xFA ,0x50 ,0xAC ,0xAA ,0x2E ,0x17 ,0x64 ,0x18 ,0xD2 ,0x74 ,0xDB ,0xDF ,0x1B ,0xB0 ,0xCA ,0xDA ,0x1C ,0x12 ,0x50 ,0xDD ,0x67 ,0xA4 ,0xA0 ,0x73 ,0x04 ,0x42 ,0x54 ,0x95 ,0xDE ,0xA9 ,0x73 ,0x9D ,0x04 ,0x36 ,0xB0 ,0xD0 ,0x3A ,0xAC ,0xB5 ,0x7D ,0x1B ,0x79 ,0xEB ,0x47 ,0x86 ,0xC2 ,0x65 ,0x42 ,0x41 ,0xCA ,0x12 ,0xC1 ,0xB4 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00};
    uint8_t temp_pub_b[ECC_PUB_SIZE = {0xF9 ,0x9A ,0x59 ,0x89 ,0x66 ,0x5A ,0xA3 ,0x8F ,0x34 ,0x5E ,0xDC ,0xE5 ,0xD6 ,0xF1 ,0x39 ,0x96 ,0x86 ,0x45 ,0x4B ,0x6B ,0x74 ,0x2F ,0x11 ,0xB2 ,0x55 ,0xF1 ,0x55 ,0x47 ,0xB6 ,0x1E ,0xB1 ,0x4B ,0x2C ,0x2E ,0xB8 ,0x2A ,0xE0 ,0x49 ,0xA9 ,0xED ,0x4F ,0x9E ,0x76 ,0xB3 ,0xE9 ,0x38 ,0x37 ,0x8F ,0x7B ,0xD3 ,0xFA ,0xC5 ,0xE1 ,0x0C ,0x0A ,0xAF ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00};
#elif uECC_SUPPORTS_secp256r1
    uint8_t temp_prv_a[ECC_PRV_SIZE] = {0x31 ,0xA1 ,0x27 ,0xAD ,0xB9 ,0x73 ,0xB8 ,0x6A ,0x40 ,0x81 ,0x68 ,0x69 ,0x48 ,0xBE ,0xBB ,0x3D ,0xAD ,0x08 ,0x58 ,0xC4 ,0xA6 ,0xE4 ,0x1C ,0xC2 ,0xCE ,0x28 ,0xD2 ,0xBD ,0x3C ,0x31 ,0xCB ,0xA7};
    uint8_t temp_prv_b[ECC_PRV_SIZE = {0x34 ,0x87 ,0x4B ,0xD8 ,0x6B ,0xE7 ,0x81 ,0x68 ,0xF5 ,0xEA ,0x03 ,0xC3 ,0x12 ,0x38 ,0x50 ,0x64 ,0x2A ,0xDB ,0x9D ,0x86 ,0x17 ,0x21 ,0x97 ,0x58 ,0x80 ,0xA1 ,0x24 ,0xAA ,0x83 ,0xD7 ,0x75 ,0x39};
    uint8_t temp_pub_a[ECC_PUB_SIZE] = {0x25 ,0x49 ,0x72 ,0xCF ,0x48 ,0x2B ,0x3E ,0x19 ,0x56 ,0x48 ,0xB4 ,0x00 ,0xD6 ,0x48 ,0xAD ,0x90 ,0x35 ,0xEC ,0x83 ,0x2F ,0x9D ,0x9C ,0xD5 ,0x05 ,0x2D ,0x0D ,0xD1 ,0x95 ,0xAA ,0xDC ,0x19 ,0xAB ,0x1B ,0xF9 ,0x2B ,0xB4 ,0xA8 ,0xE5 ,0xD6 ,0x78 ,0x6E ,0x4F ,0xB1 ,0xF1 ,0xCD ,0x0F ,0xDE ,0xCF ,0x35 ,0xEF ,0x7F ,0x86 ,0xCB ,0x94 ,0x64 ,0xC9 ,0xE5 ,0x11 ,0xCB ,0x17 ,0xF4 ,0x65 ,0x05 ,0xFB};
    puuint8_t temp_pub_b[ECC_PUB_SIZEb_b = {0xB1 ,0x8E ,0x9E ,0x98 ,0xF5 ,0x8D ,0xFE ,0xE4 ,0x39 ,0xB2 ,0xC4 ,0x60 ,0x80 ,0xDA ,0xAA ,0xC8 ,0x9B ,0xA7 ,0xA6 ,0x66 ,0x71 ,0x84 ,0x0D ,0x03 ,0x05 ,0x1E ,0x9F ,0x8D ,0xD1 ,0xA6 ,0xE6 ,0x2C ,0xFB ,0xD6 ,0x75 ,0xB5 ,0x58 ,0x23 ,0x77 ,0x3E ,0xF8 ,0xF9 ,0x11 ,0x2D ,0xFC ,0x47 ,0x6E ,0x69 ,0x0A ,0x21 ,0xC4 ,0x7D ,0x0D ,0x49 ,0xB7 ,0x10 ,0xB6 ,0xD2 ,0xC5 ,0xF7 ,0x56 ,0xCA ,0xE7 ,0x09};
#elif uECC_SUPPORTS_secp256k1
    uint8_t temp_prv_a[ECC_PRV_SIZE] = {0x4A ,0xE5 ,0xD8 ,0x76 ,0x2D ,0x40 ,0x61 ,0xBD ,0x0A ,0x5A ,0xB4 ,0x82 ,0x8E ,0x59 ,0x40 ,0x7E ,0x82 ,0x5D ,0x8F ,0x00 ,0xC0 ,0x52 ,0x94 ,0x2A ,0x96 ,0x6F ,0x8D ,0x06 ,0xE9 ,0x41 ,0x0D ,0xC8};
    uint8_t temp_prv_b[ECC_PRV_SIZE] = {0x0A ,0x76 ,0x4B ,0x66 ,0x68 ,0xDF ,0xFC ,0xF4 ,0x27 ,0x57 ,0x3D ,0x01 ,0xC4 ,0xE7 ,0xBB ,0x4E ,0x73 ,0x9D ,0x87 ,0x22 ,0xEC ,0xA6 ,0xCC ,0x12 ,0x4A ,0x49 ,0x77 ,0xBC ,0xCF ,0x36 ,0x94 ,0xC4};
    uint8_t temp_pub_a[ECC_PUB_SIZE] = {0xDC ,0xE4 ,0x62 ,0x17 ,0x1A ,0xE5 ,0x27 ,0x9E ,0x61 ,0xD4 ,0xE8 ,0x9C ,0xB3 ,0xC1 ,0x56 ,0x65 ,0x43 ,0x8B ,0x4B ,0x44 ,0xFC ,0x8C ,0x0A ,0x2F ,0x11 ,0x67 ,0x79 ,0x7E ,0xCE ,0x25 ,0x24 ,0xCB ,0x8A ,0x00 ,0x23 ,0x74 ,0x9E ,0x07 ,0x2E ,0xB5 ,0xBF ,0xBC ,0x59 ,0x2D ,0xF5 ,0x93 ,0xDA ,0x71 ,0x90 ,0x7C ,0x75 ,0xC8 ,0x1E ,0x50 ,0xBD ,0x1B ,0x82 ,0x0B ,0x18 ,0xC6 ,0xAF ,0x1D ,0xBB ,0x20};
    uint8_t temp_pub_b[ECC_PUB_SIZE] = {0x33 ,0x02 ,0xF7 ,0xD0 ,0xE9 ,0xB7 ,0x03 ,0xA6 ,0xB6 ,0xC8 ,0xCD ,0x6E ,0x73 ,0xA7 ,0x46 ,0x70 ,0xDE ,0x27 ,0xBB ,0xF5 ,0x4F ,0x44 ,0xAA ,0x35 ,0x80 ,0x24 ,0x28 ,0x5B ,0x20 ,0x1D ,0xAA ,0x95 ,0xA0 ,0x39 ,0xF7 ,0x41 ,0x4A ,0xF2 ,0x3E ,0xA3 ,0xFC ,0x08 ,0x5F ,0x28 ,0x7E ,0x2C ,0x31 ,0xAB ,0x9D ,0xAA ,0x74 ,0xE0 ,0xA1 ,0x30 ,0xFB ,0xBB ,0x12 ,0x4B ,0x13 ,0xC8 ,0x72 ,0x35 ,0x1C ,0xAE};
#endif
    for(int i = 0; i < ECC_PRV_SIZE; i++) {
        prv_a[i] = temp_prv_a[i];
        prv_b[i] = temp_prv_b[i];
    }

    for(int i = 0; i < ECC_PUB_SIZE; i++) {
        pub_a[i] = temp_pub_a[i];
        pub_b[i] = temp_pub_b[i];
    }
#endif
}

void generate_share_secret(){
#if defined(TINY_ECC)
    ecdh_shared_secret(prv_a, pub_b, sec_a);
#elif defined(BSD)
#if uECC_SUPPORTS_secp160r1
    curves = uECC_secp160r1();
#endif
#if uECC_SUPPORTS_secp192r1
    curves = uECC_secp192r1();
#endif
#if uECC_SUPPORTS_secp224r1
    curves = uECC_secp224r1();
#endif
#if uECC_SUPPORTS_secp256r1
    curves = uECC_secp256r1();
#endif
#if uECC_SUPPORTS_secp256k1
    curves = uECC_secp256k1();
#endif

    if (!uECC_shared_secret(pub_b, prv_a, sec_a, curves)) {
        printf("shared_secret() failed (1)\n");
        return;
    }

#endif
}

void check_result() {

#if defined(TINY_ECC)

    for (i = 0; i < ECC_PRV_SIZE; ++i)
    {
        prv_b[i] = prng_next();
    }
    ecdh_generate_keys(pub_b, prv_b);
    
    ecdh_shared_secret(prv_b, pub_a, sec_b);
#elif defined(BSD)
    if (!uECC_shared_secret(pub_a, prv_b, sec_b, curves)) {
        printf("shared_secret() failed (2)\n");
        return;
    }
#endif
    for (i = 0; i < ECC_PUB_SIZE; ++i)
    {
        assert(sec_a[i] == sec_b[i]);
    }
}

int main(){

    init_ecc();
    generate_share_secret();
    check_result();

    return 0;
}